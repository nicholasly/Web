
var task = require("./../../app/task");
var plugin = require("./../../app/plugin");

var exec = require("child_process").exec;


var Plugin = {
	"install" : function(req,res,isupgrade){
		var _plugin = plugin.get(req.query.name);
		if(isupgrade){
			_plugin.update();
		}else{
			_plugin.install();
		}
		
		var checkStatus = function(req,res){
			if(_plugin.status !== "ok"){
				setTimeout(function(){checkStatus(req,res)},1000);	
			}else{
				res.jsonp(_plugin);
			}		
		}
		checkStatus(req,res);
	},
	"state" : function(req,res){
		var _plugin = plugin.get(req.query.name);
		res.jsonp(_plugin);
	},
	"update" : function(req,res){
		this.install(req,res,true);
	}
}

module.exports = function(req,res){
	var subapp = req.params[1] || "index";
	Plugin[subapp](req,res);
}
